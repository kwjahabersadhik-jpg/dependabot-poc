@page "/standing-order-list"
@using CreditCardsSystem.Domain.Common;
@using CreditCardsSystem.Domain.Enums;
@using CreditCardsSystem.Domain.Models.CardOperation;
@using CreditCardsSystem.Domain.Models.SupplementaryCard;
@using CreditCardsSystem.Domain.Models.StandingOrder;
@using CreditCardsSystem.Utility.Extensions;
@using CreditCardsSystem.Web.Client.Components.Elements
@using CreditCardsSystem.Web.Client.Pages.CardDetails.Skeletons
@using CreditCardsSystem.Web.Client.Pages.CardRequest;
@using CreditCardsSystem.Web.Client.Pages.CustomerProfile;


@inherits ApplicationComponent
@inject IFeesAppService _feesAppService
@inject IStandingOrderAppService _standingOrderAppService

@inject NavigationManager nvm

@if (State?.StandingOrders.Status == DataStatus.Success)
{

    <div class="table-header mt-5 mx-0">
        <Title Text="Standing Orders"> </Title>
        <div class="table-selectedFilters">
            @* <SingleDropdown Type="TransferType" DropDownData="Enum.GetNames<EStandingOrderTransferType>().ToList()" SelectedValue="@selectedTransferType.ToString()" SelectedValueChanged="OnChangeTransferType"></SingleDropdown> *@
            <OnClickComponent OnClick=@(async()=> await OnChangeAction(null))>
                <CircleIcon Icon="icon-Plus" Id="opennewacc" Title="Add Standing Order" />
            </OnClickComponent>
            <TelerikTooltip TargetSelector="#opennewacc" Position="TooltipPosition.Bottom"></TelerikTooltip>
        </div>
    </div>

    <div class="kfh-data-table p-0 mt-0">
        <TelerikGrid Data="@FilteredStandingOrders" @ref=StandingOrderGridRef Pageable="true" Sortable="false">
            <GridColumns>

                @* <GridColumn Field="" OnCellRender="@((e) => e.Class = "col-md-1  text-start")" HeaderClass="col-md-1 text-start">
                    <Template>
                        <div class="ps-4">
                            <CircleIcon Icon="icon-Internal" />
                        </div>
                    </Template>
                </GridColumn> *@

                <GridColumn Field="Orders Details" OnCellRender="@((e) => e.Class = "col-3 ps-4 text-start")" HeaderClass="col-3 ps-4 text-start">
                    <Template>
                         <div class="details-col">
                            @{
                                <div class="ps-4">
                                    <CircleIcon Icon="icon-Internal" CircleSize="45px" IConSize="20px"/>
                                </div>

                                var item = context as StandingOrderDto;
                                <div>
                                        <div class="d-flex flex-column text-start ps-4">
                                            <H2 class="my-0 text-start">@item!.PayeeName</H2>
                                            <div class="d-flex align-items-center gp-16">
                                                <H3 Class="my-0 text-start text-gray50">@item?.SourceAccount</H3>
                                                <span class="icon-LTR text-gray50"></span>
                                                <H3 Class="my-0 text-start text-gray50">@item?.DestinationAccount</H3>
                                            </div>
                                            @* <SubH1 class="text-start">@item!.Description</SubH1>
                                            <SubH1 class="text-start">@item!.TransferType</SubH1> *@
                                        </div>
                                    </div>
                            }
                        </div>
                    </Template> 
                </GridColumn>
                <GridColumn Field="Amount" OnCellRender="@((e) => e.Class = "col-xl-3")" HeaderClass="col-xl-3">
                    <Template>
                        @{
                            var item = context as StandingOrderDto;
                            if (item?.Amount != null || item?.Amount > 0)
                            {
                                <H3>@item.Amount.ToMoney(" ") <SubH2>@(item.Currency ?? "KWD")</SubH2></H3>
                            }
                            else
                            {
                                <H2>N/A</H2>
                            }
                        }
                    </Template>
                </GridColumn>
                <GridColumn HeaderClass="col-xl-3" OnCellRender="@((e) => e.Class = "col-xl-3")" Field="Next Transfer Date">
                    <Template>
                        @{
                            var item = context as StandingOrderDto;
                            <H4>@item?.NextTransferDate.Formed()</H4>
                        }
                    </Template>
                </GridColumn>
                <GridColumn HeaderClass="col-xl-3" OnCellRender="@((e) => e.Class = "col-xl-3")" Field="Expiry Date">
                    <Template>
                        @{
                            var item = context as StandingOrderDto;
                            <H4>@item?.EndDate?.Formed()</H4>
                        }
                    </Template>
                </GridColumn>
               
                <GridCommandColumn HeaderClass="col-xl-1" OnCellRender="@((e) => e.Class = "col-xl-1")">
                    @{
                        var item = context as StandingOrderDto;
                        List<ListItem<string>> Actions = new();
                        if (item!.AllowUpdate)
                        {
                            Actions.Add(new("Edit", "Edit"));
                        };

                        if (item!.AllowDelete)
                        {
                            Actions.Add(new("Delete", "Delete"));
                        }

                        <ActionMenuNew Data="@Actions" Status="DataStatus.Success" Callback="@(async (ListItem<string> selectedItem)=> { SelectedStandingOrder=item!; await ActionSelectionChanged(selectedItem); } )" />
                    }
                </GridCommandColumn>

            </GridColumns>
            <NoDataTemplate>
                <NoRecordsFound />
            </NoDataTemplate>
        </TelerikGrid>

        <TelerikDialog @bind-Visible="@ShowDeleteDialog" Class="modal-dialog" CloseOnOverlayClick="true" ShowCloseButton="false">
            <DialogContent>
                <div class="dialog-content">
                    <div class="dialog-header">
                        <span class="dialog-icon icon-Critical" />
                        <H2>Delete standing order</H2>
                    </div>
                    <H4>You’re about to delete standing order <b>@SelectedStandingOrder?.StandingOrderId?</b></H4>
                    <div class="dialog-buttons">
                        <Button Type="btn-text btn-sm" Label="Cancel" OnClick="@(() => { ShowDeleteDialog = false; })" />
                        <Button Type="btn-secondary--critical btn-sm" Label="Yes" OnClick="@(async () => { await ConfirmDeleteStandingOrder(); })" />
                    </div>
                </div>
            </DialogContent>
        </TelerikDialog>
    </div>
}
else if (State?.StandingOrders.Status == DataStatus.Loading)
{
    <div class="table-header mt-6 mx-0">
        <Title Text="Standing Orders"> </Title>
        <div class="table-selectedFilters">
            @* <SingleDropdown Type="TransferType" DropDownData="Enum.GetNames<EStandingOrderTransferType>().ToList()" SelectedValue="@selectedTransferType.ToString()" SelectedValueChanged="OnChangeTransferType"></SingleDropdown> *@
            <OnClickComponent OnClick=@(async()=> await OnChangeAction(null))>
                <CircleIcon Icon="icon-Plus" Id="opennewacc" Title="Add Standing Order" />
            </OnClickComponent>
            <TelerikTooltip TargetSelector="#opennewacc" Position="TooltipPosition.Bottom"></TelerikTooltip>
        </div>
    </div>

    <div class="kfh-data-table ">
        <div class="col-12 p-5">
            <SkeletonBuilder Type="Table" Rows="4" Columns="5" ColWidth="100" ColHeight="15" Margin="my-4"></SkeletonBuilder>
        </div>
        @* <DataTableSkeleton /> *@
    </div>
}
else if (State?.StandingOrders.Status == DataStatus.Error)
{
    <EmptyState IconName="tech-error" Heading="Technical Error" Description="An error occurred in retrieving data, please contact support team."></EmptyState>
}




<RequestMakerPage @ref=cardRequestFormRef ReloadData="GetStandingOrders" />
