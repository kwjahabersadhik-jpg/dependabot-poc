@page "/application-status"

@using CreditCardsSystem.Data.Models;
@using CreditCardsSystem.Domain.Common;
@using CreditCardsSystem.Domain.Enums;
@using CreditCardsSystem.Domain.Models.Card
@using CreditCardsSystem.Domain.Models.CardIssuance;
@using CreditCardsSystem.Domain.Models.Request;
@using CreditCardsSystem.Domain.Models.StandingOrder;
@using CreditCardsSystem.Utility.Extensions;


@inject ICardIssuanceAppService cardIssueService;
@inject IRequestAppService requestService;
@inject ICardDetailsAppService cardDetailsService;
@inherits ApplicationComponent;

<div class="main-container">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center pt-3">
            <div>
                <Title Text="Application Status"></Title>
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <div class="p-3">
                    <OnClickComponent OnClick="async () => await FiltersDrawerRef.ToggleAsync()">
                        <CircleIcon Icon="icon-Filter" Title="Filter" Id="BottomTooltip" />
                    </OnClickComponent>
                    <TelerikTooltip TargetSelector="#opennewacc" Position="TooltipPosition.Bottom"></TelerikTooltip>
                </div>
            </div>
        </div>

        <div class="KFHnopadding kfh-data-table">
            @if (RequestListStatus.Status == DataStatus.Loading)
            {
                <div class="col-12 p-5">
                    <SkeletonBuilder Type="Table" Rows="4" Columns="5" ColWidth="100" ColHeight="15" Margin="my-4"></SkeletonBuilder>
                </div>
                @* <DataTableSkeleton></DataTableSkeleton> *@
            }
            else
            {
                <TelerikGrid @ref="requestGrid" Data="@Requests" EditMode="@GridEditMode.Inline" EnableLoaderContainer=true
                             Pageable="true" PageSize="20" Width="100%" Resizable="true" Reorderable="true" Groupable="true"
                             Sortable="true" AutoGenerateColumns=true SortMode="@SortMode.Multiple">
                    <GridColumns>
                        <GridColumn Locked="true">
                            <Template>
                                @{
                                    var ctx = context as RequestDto;
                                }
                                <TelerikButton Class="text-btn enabled-btn" OnClick="@(async ()=> await ViewParameter(ctx.RequestId))" ButtonType="ButtonType.Button">
                                    <div class="d-flex align-items-center">
                                        Parameters
                                        <span class="icon-LTR me-2"></span>
                                    </div>
                                </TelerikButton>

                                <TelerikButton Class="text-btn enabled-btn" OnClick="@(async ()=> await ViewEligibleActions(ctx.RequestId,ctx.CardNo))" ButtonType="ButtonType.Button">
                                    <div class="d-flex align-items-center">
                                        View Eligible Actions
                                        <span class="icon-LTR me-2"></span>
                                    </div>
                                </TelerikButton>
                            </Template>
                        </GridColumn>
                        <GridColumn Field="Card Number" OnCellRender="@((e) => e.Class = "Cell17 AO-detailed--cell")" HeaderClass="Cell17 AO-detailed--cell">
                            <Template>
                                @{
                                    var item = context as RequestDto;
                                }
                                <div class="d-flex align-items-center">
                                    <a onclick="@(()=> @GoToStatementPage(item!.RequestId!))">
                                        <H2>@DisplayCardNumber(item?.CardNo)</H2>
                                    </a>
                                </div>


                            </Template>
                        </GridColumn>

                        <GridColumn Field="Card Status" OnCellRender="@((e) => e.Class = "Cell5")" HeaderClass="Cell5">
                            <Template>
                                @{
                                    var item = context as RequestDto;
                                }
                                @(((CreditCardStatus)item.ReqStatus).ToString())
                            </Template>
                        </GridColumn>

                        <GridAutoGeneratedColumns></GridAutoGeneratedColumns>
                    </GridColumns>
                    <NoDataTemplate>
                        <NoRecordsFound />
                    </NoDataTemplate>
                </TelerikGrid>
            }
        </div>

        <TelerikDialog @ref="DialogRef" @bind-Visible="_dialogVisible" ButtonsLayout="DialogButtonsLayout.End" Class="KFH-dialog" Width="50%" Height="90%">
            <DialogTitle>
                <p role="status">Request Parameters of (@Parameters[0].ReqId)</p>
            </DialogTitle>
            <DialogContent>
                <div class="tables" style="width: 100%;">
                    <div class="KFHnopadding kfh-data-table shadow">
                        <TelerikGrid Data="@Parameters" EditMode="@GridEditMode.Inline"
                                     Pageable="true" PageSize="20" Width="100%" Resizable="true" Reorderable="true" Groupable="true"
                                     Sortable="true" SortMode="@SortMode.Multiple">
                            <GridColumns>
                                <GridColumn Field="Parameter"></GridColumn>
                                <GridColumn Field="Value"></GridColumn>
                            </GridColumns>
                        </TelerikGrid>
                    </div>
                </div>
            </DialogContent>
            <DialogButtons>
                <TelerikButton OnClick="@(() => { _dialogVisible = false; })">Close</TelerikButton>
            </DialogButtons>
        </TelerikDialog>

        <TelerikDialog @ref="DialogCardInfoRef" @bind-Visible="_dialogCardInfoVisible" ButtonsLayout="DialogButtonsLayout.End" Class="KFH-dialog" Width="50%" Height="90%">
            <DialogTitle>
                <p role="status">Card Detail (@cardDetails.Data?.RequestId)</p>
            </DialogTitle>
            <DialogContent>
                <div class="tables" style="width: 100%;">
                    <div class="KFHnopadding kfh-data-table shadow">

                        @if (cardDetails.Status == DataStatus.Loading)
                        {
                            <TelerikSkeleton Width="324px" Visible="true" class="AO-skeleton-rectangle AO-cardTitle-skeleton AO-skeleton--ML"></TelerikSkeleton>

                            @for (var i = 0; i < 3; i++)
                            {
                                <div class="AO-Skeleton--datatable--header">
                                    <div class="AO-Skeleton-Grid-5">
                                        <TelerikSkeleton Width="250px" Visible="true" class="AO-skeleton-rectangle AO-cardTitle-skeleton"></TelerikSkeleton>
                                        <TelerikSkeleton Width="250px" Visible="true" class="AO-skeleton-rectangle AO-cardTitle-skeleton"></TelerikSkeleton>
                                    </div>
                                </div>
                            }
                        }
                        @if (cardDetails.Status == DataStatus.Error)
                        {
                            <span>@cardDetails.Exception.Message</span>
                        }

                        @if (cardDetails.Status == DataStatus.Success)
                        {
                            <TelerikGrid Data="@cardDetails.Data.EligibleActions" EditMode="@GridEditMode.Inline"
                                         Pageable="true" PageSize="20" Width="100%" Resizable="true" Reorderable="true" Groupable="true"
                                         Sortable="true" SortMode="@SortMode.Multiple">
                                <GridColumns>
                                    <GridColumn Field="Text"></GridColumn>
                                    <GridColumn Field="Value"></GridColumn>
                                </GridColumns>
                            </TelerikGrid>
                        }
                    </div>
                </div>
            </DialogContent>
            <DialogButtons>
                <TelerikButton OnClick="@(() => { _dialogCardInfoVisible = false; })">Close</TelerikButton>
            </DialogButtons>
        </TelerikDialog>
    </div>
</div>

<OffCanvas @ref="FiltersDrawerRef" Title="Filters">
    <OffcanvasContent>

        <div class="d-flex flex-column gp-0">
            <div class="formField">

                <div class="form-flex gp-8">

                    <H3>Search Requests</H3>

                    <FormList Class="d-flex gp-32 mt-0">

                        <Form Label="Application">
                            <TelerikDropDownList Data="@applications" TextField="name" ValueField="value" DefaultText="-- All Applications --" @bind-Value="@filter.Application">
                                <DropDownListSettings>
                                    <DropDownListPopupSettings MaxHeight="200px" />
                                </DropDownListSettings>
                            </TelerikDropDownList>
                        </Form>

                        <Form Label="Seller Id">
                            <TelerikNumericTextBox @bind-Value="@filter.SellerId" Arrows=false Placeholder="Enter SellerId..."></TelerikNumericTextBox>
                        </Form>

                        <Form Label="Customer CivilId">
                            <TelerikTextBox @bind-Value="@filter.CustomerCivilId" Placeholder="Enter Customer CivilId..."></TelerikTextBox>
                        </Form>

                        <Form Label="Collateral">
                            <TelerikDropDownList Data="@collateralData" TextField="name" ValueField="value" DefaultText="-- All Collateral --" @bind-Value="@filter.Collateral">
                                <DropDownListSettings>
                                    <DropDownListPopupSettings MaxHeight="200px" />
                                </DropDownListSettings>
                            </TelerikDropDownList>
                        </Form>

                        <Form Label="Created Date">
                            <TelerikDatePicker AutoComplete="true" Format="dd/MM/yy" @bind-Value="filter.RequestedDateFrom" Class="dateTime-filter"></TelerikDatePicker>
                        </Form>


                        <Form Label="Product Category">
                            <TelerikDropDownList Data="@categories" TextField="name" ValueField="value" DefaultText="-- All Category --" @bind-Value="@filter.Category">
                                <DropDownListSettings>
                                    <DropDownListPopupSettings MaxHeight="200px" />
                                </DropDownListSettings>
                            </TelerikDropDownList>
                        </Form>



                        <Form Label="Product Type">
                            <TelerikDropDownList Data="@productTypes" TextField="name" ValueField="value" DefaultText="-- Select a product type --" @bind-Value="@ProductType" OnChange="GetAllProducts">
                                <DropDownListSettings>
                                    <DropDownListPopupSettings MaxHeight="200px" />
                                </DropDownListSettings>
                            </TelerikDropDownList>
                        </Form>

                        <Form Label="Product">
                            <TelerikDropDownList Id="ownedCardNumber" @bind-Value="filter.ProductId" Data="products" TextField="ProductName" ValueField="ProductID"
                                                 AdaptiveMode="AdaptiveMode.Auto" DefaultText="-- All Cards --"
                                                 Filterable=true FilterOperator="StringFilterOperator.Contains">
                                <DropDownListSettings>
                                    <DropDownListPopupSettings Height="500px"></DropDownListPopupSettings>
                                </DropDownListSettings>
                                <ItemTemplate>
                                    @{
                                        var _card = context as CardEligiblityMatrixDto;
                                        var image = GetCreditCardImage(_card!.ProductID);
                                        <div class="card">
                                            <picture class="p-2">
                                                <img src="@image" style="width:100px; height:65px;" onerror="if(this.src != '@image') this.src = '@DefaultImage';" />
                                            </picture>
                                        </div>
                                        <div>
                                            <p>@_card.ProductName</p>
                                        </div>
                                    }
                                </ItemTemplate>
                            </TelerikDropDownList>
                        </Form>


                        <Form Label="Status">
                            <TelerikDropDownList Data="@requestStatus" TextField="name" ValueField="value" DefaultText="-- All Status --" @bind-Value="@filter.RequestStatus">
                                <DropDownListSettings>
                                    <DropDownListPopupSettings MaxHeight="200px" />
                                </DropDownListSettings>
                            </TelerikDropDownList>
                        </Form>

                        <Form Label="Card Number">
                            <TelerikTextBox @bind-Value="@filter.CardNumber" Placeholder="Enter Card Number..."></TelerikTextBox>
                        </Form>

                        <Form Label="Request Id">
                            <TelerikNumericTextBox @bind-Value="@filter.RequestId" Placeholder="Enter RequestId..."></TelerikNumericTextBox>
                        </Form>

                    </FormList>
                </div>
            </div>
        </div>
    </OffcanvasContent>
    <OffcanvasFooterContent>
        <div class="drawer-buttons justify-content-between">
            <Button Type="btn-secondary" ButtonType="@ButtonType.Button" Label="Reset" OnClick="Reset"></Button>
            <Button Type="btn-primary" ButtonType="@ButtonType.Submit" Label="Search" OnClick="Search"></Button>
        </div>
    </OffcanvasFooterContent>
</OffCanvas>


@code {

    public OffCanvas FiltersDrawerRef { get; set; }
    public RequestFilter filter { get; set; } = new();
    public ProductTypes ProductType { get; set; }
    private record collateralRecord(string name, Collateral value);
    private record productRecord(string name, ProductTypes value);
    private record applicationRecord(string name, Applications value);
    private record categotyRecord(string name, ProductCategory value);
    private record cardStatus(string name, CreditCardStatus value);


    private List<collateralRecord> collateralData = new();
    private List<productRecord> productTypes = new();
    private List<applicationRecord> applications = new();
    private List<categotyRecord> categories = new();
    private List<cardStatus> requestStatus = new();


    private List<CardEligiblityMatrixDto> products { get; set; }
    private TelerikGrid<RequestDto> requestGrid { get; set; }
    public List<RequestDto> Requests { get; set; } = new();
    public List<RequestParameter> Parameters { get; set; } = new();

    private DataItem<List<RequestDto>> RequestListStatus { get; set; } = new();

    private DataItem<CardDetailsResponse> cardDetails { get; set; } = new();
    // public  RequestList { get; set; }
    TelerikDialog DialogRef;
    private bool _dialogVisible;

    TelerikDialog DialogCardInfoRef;
    private bool _dialogCardInfoVisible;

    protected override async Task OnInitializedAsync()
    {
        await BindDropDownData();
    }

    private async Task ViewParameter(decimal reqId)
    {


        Parameters = await requestService.GetParameters(reqId);
        DialogRef.Refresh();
        _dialogVisible = true;
    }
    private async Task Reset()
    {
        filter = new();
        Requests = new();
        ProductType = ProductTypes.All;
        StateHasChanged();
        await Task.CompletedTask;

    }
    private async Task Search()
    {
        await FiltersDrawerRef.ToggleAsync();
        RequestListStatus.Loading();
        var result = await requestService.GetAllRequests(filter);
        if (result.IsSuccessWithData)
        {
            RequestListStatus.SetData(result.Data!);
            Requests = RequestListStatus.Data!;
        }
        StateHasChanged();
        await Task.Delay(1);
        await requestGrid.AutoFitAllColumnsAsync();

    }
    private async Task ViewEligibleActions(decimal requestId, string cardNumber)
    {
        _dialogCardInfoVisible = true;
        cardDetails.Loading();

        var resp = await cardDetailsService.GetCardInfo(requestId, cardNumber, includeCardBalance: true);
        if (!resp.IsSuccess)
            cardDetails.Error(new(resp.Message));
        else
            cardDetails.SetData(resp.Data);

        DialogCardInfoRef.Refresh();

    }

    async Task GoToStatementPage(decimal requestId)
    {

        NavigateTo($"credit-card-statement?RequestId={requestId}");
        await Task.CompletedTask;
    }

    private async Task BindDropDownData()
    {
        collateralData.AddRange(Enum.GetNames(typeof(Collateral)).Select(item => new collateralRecord(item.GetDescription(), (Collateral)Enum.Parse(typeof(Collateral), item))));

        productTypes.AddRange(Enum.GetNames(typeof(ProductTypes)).Select(item => new productRecord(item, (ProductTypes)Enum.Parse(typeof(ProductTypes), item))));

        applications.AddRange(Enum.GetNames(typeof(Applications)).Select(item => new applicationRecord(item, (Applications)Enum.Parse(typeof(Applications), item))));

        categories.AddRange(Enum.GetNames(typeof(ProductCategory)).Select(item => new categotyRecord(item, (ProductCategory)Enum.Parse(typeof(ProductCategory), item))));

        requestStatus.AddRange(Enum.GetNames(typeof(CreditCardStatus)).Select(item => new cardStatus(item.GetDescription(), (CreditCardStatus)Enum.Parse(typeof(CreditCardStatus), item))));

        await Task.CompletedTask;
    }

    private async Task GetAllProducts()
    {
        try
        {
            var allCardsResponse = await cardIssueService.GetAllProducts(ProductType);
            if (allCardsResponse.IsSuccessWithData)
            {
                products = allCardsResponse.Data!;
                StateHasChanged();
            }
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
            throw;
        }
    }


    #region Date Time

    private
        DateTime? SelectedCreatedDateTime
    { get; set; }


    private void OnSelectedCreatedDateTimeChanged(DateTime? createDate)
    {
        SelectedCreatedDateTime = createDate;
    }

    private
        DateTime? SelectedCompletionDateTime
    { get; set; }

    private void OnSelectedCompletionDateTimeChanged(DateTime? createDate)
    {
        SelectedCompletionDateTime = createDate;
    }

    #endregion

    public
         DateTime Min = new DateTime(1990, 1, 1, 8, 15, 0);

    public
        DateTime MaxDate = new DateTime(DateTime.Now.Year + 1, 1, 1, 0, 0, 0);


}